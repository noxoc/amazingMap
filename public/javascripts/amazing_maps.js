/**
 * Amazing Maps for jQuery
 *
 * @author Nils Riedemann (@nerdism)
 */

(function($) {
  /**
   * Add the Plugin to jQuery
   */
  $.fn.amazingMap = function(method) {
    var map      = undefined,
        $this = $(this),
        geocoder = new google.maps.Geocoder(),
        markerBounds = new google.maps.LatLngBounds(),
        addresses = {},
        directionsDisplay,
        directionsService,
        settings = {
          zoom: 1,
          center: [0, 0],
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          bounds: false
        };
    var templates = {//{{{
      routeForm: function(vars) {
        // TODO: hopefully, someday we can use jquery-templates instead of this
        // quickndirty thing
        return '<div id="'+ vars.id +'" class="amazingMap-routeForm">'//{{{
          + '<form>'
            + '<label>' + vars.label + '</label>'
            + '<input type="hidden" name="destination"'
              + ' value="'+ vars.destination +'">'
            + '<input type="text" name="origin">'
            + '<input type="submit" value=' + vars.submit +'>'
          + '</form>'
          + '<div class="route_panel"></div>'
        + '</div>'//}}}
      }
    };//}}}
    // Methods {{{
    var methods = {

      /**
      * initialize plugin
      *
      * TODO: write a decent explanation of data right here
      *
      * @param JSON data
      */
      init: function(data) {//{{{
        // override default settings if specified
        if(data && data) {
          $.extend(settings, data);
        }

        return this.each(function() {
          map = new google.maps.Map(this, {
            // TODO: create a more intuitive interface for mapTypeId
            mapTypeId: settings.mapTypeId,
            zoom: settings.zoom
          });

          if(settings.routeTo) {
            methods.addRouteForm(settings.routeTo)
          }

          // Store the Map-instance so we don't need to pass it around and can
          // use the methods more intutively.
          $(this).data('map', map);

          // Set style if given
          if(settings.style) {
            methods.setStyle(settings.style);
          }

          // Set the center using our method, so we can use addresses 
          // as well. 
          methods.setCenter(settings.center);

          // Add a marker to the map if give
          if(settings.marker) {
            methods.addMarker(settings.marker)
          } 

          // Add multiple markers to the map
          if (settings.markers) {
            methods.addMarkers(settings.markers);
          }
          return this;
        });
      },//}}}

      /**
       * Add a form for route-search
       * TODO: make this way more flexible with options
       *
       * @param JSON options where should the route be generated to?
       */
      addRouteForm: function(options) {//{{{
        var id = $this.attr('id') + '-routeForm',
        // TODO: Refactor this ternary mess
            destination = (typeof(options) == 'string') 
                            ? options 
                            : ( options.destination )
                              ? options.destination
                              : options.position;

        // Settting up the needed services - if it did not yet happen
        if(!directionsDisplay)
          directionsDisplay = new google.maps.DirectionsRenderer();

        if(!directionsService)
          directionsService = new google.maps.DirectionsService();

        // add the form after the map
        $(templates.routeForm({
          label: ( options.label ) ? options.label : 'Start at:',
          destination: destination,
          submit: (options.submit) ? options.submit : 'Search',
          id: id
        })).insertAfter($this);

        directionsDisplay.setMap(map);
        directionsDisplay.setPanel(document.getElementById(id));


        // TODO: refactor this (create a callback for the event)
        $('form', '#'+id).live('submit',function(event) {
          event.preventDefault();
          directionsService.route({
            origin: $('input[name=origin]').val(),
            destination: destination,
            travelMode: google.maps.DirectionsTravelMode.DRIVING,
            unitSystem: google.maps.DirectionsUnitSystem.METRIC,
          }, function(response, status) {
            if(status == google.maps.DirectionsStatus.OK) {
              directionsDisplay.setDirections(response);
            } else {
              // TODO: Use route_panel instead of alert()?
              alert('Sorry no route found');
            }
          });
        });

        return this;
      },//}}}
      /**
       * set the style for the map. Best used with google's style wizard.
       * Expects options to be the generated JSON anyway.
       *
       * http://gmaps-samples-v3.googlecode.com/svn/trunk/styledmaps/wizard/index.html
       * @param JSON option the JSON for the style as generated by google's
       * style wizard
       */
      setStyle: function(options) {//{{{
        map.mapTypes.set('custom', new google.maps.StyledMapType(options), {
          name: 'custom'
        });
        map.setMapTypeId('custom');

        return this;
      },//}}}
      /**
       * Calls addMarker() for each item in array.
       *
       * @param Array markers an array of markers 
       */
      addMarkers: function(markers) {//{{{
        // really no rocket science here
        for (var i = 0; i < settings.markers.length; i++) {
          methods.addMarker(settings.markers[i]);
        };

        return this;
      },//}}}

      /**
       * Will add a marker to the map and create an infowindow when
       * a description was given
       *
       * @param JSON marker a hash for a marker
       */
      addMarker: function(options) {//{{{
        if(typeof(options) == 'string'){
          // A string was given for the marker, recall with appropriate format
          methods.addMarker({position: options});
        } else if (typeof(options.position) == 'string') {
          // A string was given. Propably an address - we're going to hit the
          // Google-API and translate the address and call this method again
          methods.translateToLatLng(options.position, function(lat, lng) {
            $.extend(options, { position: [lat, lng] });
            methods.addMarker(options);
          });
        } else {
          var marker,
              infowindow,
              markerOptions = {},
              latlng = methods.createLatLng( options.position );

          // extend the map's bounds for zooming purposes
          markerBounds.extend(latlng);

          markerOptions = {
            position: latlng,
            map: map,
            title: options.title
          };

          // initialize routeForm and all that stuff
          if(options.routeTo){
            methods.addRouteFormTo(options.routeTo);
          }

          // google treats a string as the value for icon as a URL to the
          // image that should be used for the icon - just as we want it
          if(options.icon && typeof(options.icon) == 'string') {
            markerOptions.icon = options.icon;
          }

          // use a custom MarkerImage for the Marker
          if(options.icon)
            markerOptions.icon = methods.createIcon(options.icon);

          // usa a custom shadow (which is just another Marker Image) for the
          // Marker
          if(options.icon && options.icon.shadow) 
            markerOptions.shadow = methods.createIcon(options.icon.shadow);

          // actually add the marker to the map
          marker = new google.maps.Marker(markerOptions);

          // fit the map into the marker's bounds
          if(settings.bounds) {
            methods.zoomToBounds();
          }

          // create an infowindow with the given description
          infowindow = new google.maps.InfoWindow({
            content: options.description
          });

          // make the marker clickable
          google.maps.event.addListener(marker, 'click', function() {
            infowindow.open(map, marker);
          });
        }

        return this;
      },//}}}

      /**
       * a helper method to create an instance of google's MarkerImage-Class
       *
       * @param JSON options 
       */
      createIcon: function(options) {//{{{
        return new google.maps.MarkerImage(
          (typeof(options) == 'string') ? options : options.url
        );
      },//}}}
      /**
       * Zoom and center the map so that every marker on the map is visible. If
       * relativeZoomLevel is defined it will zoom out/in by the number given.
       *
       * @param String realtiveZoomLevel expects a string in the format of +1,
       */
      zoomToBounds: function(relativeZoomLevel) {//{{{
        map.fitBounds(markerBounds);
        if(relativeZoomLevel) {
          methods.setZoom(relativeZoomLevel);
        }
        return this;
      },//}}}
      
      /**
       * Set the zoom-level of the map to a fix number
       *
       * @param Integer zoomLevel the desired zoom-level
       */
      setZoom: function(zoomLevel) {//{{{
        // TODO: support zoomLevel relative to fitBounds()
        map.setZoom(zoomLevel);
        
        return this;
      },//}}}
      
      /**
       * Take a String and look-up the corresponding Latitude and Longitude
       * using the GoogleMaps-API
       *
       * @param String address the address to be translated
       * @param Closure callback(result) the callback that will be called,
       * when the address was successfully translated
       */
      translate: function(address, callback) {//{{{
        // simple caching: Store the address as the key and the result as the
        // value of the addresses-hash.
        if(addresses[address]){
          callback(
            addresses[address][0].geometry.location.lat(),
            addresses[address][0].geometry.location.lng()
          );
        } else {
          // no cached address, need to hit that google-service
          geocoder.geocode({
            address: address
          }, function(result, status) {
            if(status == google.maps.GeocoderStatus.OK) {
              // address was successfully translated
              addresses[address] = result;
              callback(result);
            } else {
              $.error('translateError');
            }
          });
        }

        return this;
      },//}}}

      /**
       * Same as the translate()-method yet the callback is called directly
       * called with lat and lng for convenience-reasons.
       *
       * @param String address The address to be translated
       * @param Closure callback(lat, lng) the callback that will be called,
       * when the address was successfully translated
       */
      translateToLatLng: function(address, callback) {//{{{
        methods.translate(address, function(result) {
          callback(
            result[0].geometry.location.lat(),
            result[0].geometry.location.lng()
          );
        });
        return this;
      },//}}}

      /**
       * Sets the center to the given position.
       *
       * @param String/Array latlng When a string is given, an address is
       * assumed and will be translated to [lat, lng] - otherwise an array in
       * that format is expected.
       */
      setCenter: function(latlng) {//{{{
        if(typeof(latlng) == 'string') {
          // an address was given - translate it and call this method again.
          methods.translateToLatLng(latlng, function(lat, lng) {
            methods.setCenter([lat, lng]);
          });
        } else {
          map.setCenter( methods.createLatLng(latlng));
        }

        return this;
      },//}}}

      /**
       * Convenience-method to quickly create a LatLng-Object from an array of
       * lat and lng
       * @param Array position an array with lat and lng as items
       */
      createLatLng: function(position) {//{{{
        return new google.maps.LatLng(
          position[0],
          position[1]
        );
      },//}}}
    };//}}}

    // The switch whether to call init or any other defined methods.
    // When calling a different method than init, reload the map-object from
    // the element's data.
    if(methods[method]) {//{{{
      map = $(this).data('map');

      if(!map) {
        // TODO: maybe initialize it instead of error?
        $.error('map not initialized.');
      }

      return methods[method].apply(
        this, 
        Array.prototype.slice.call(arguments, 1)
      );
    } else if (typeof method === 'object' || !method) {
      return methods.init.apply(this, arguments);
    } else {
      $.error('Method: ' + method + ' not found in amazingMaps');
    }
  };//}}}
})(jQuery);

// vim: set ts=8 sw=2 tw=79 foldmarker={{{,}}}:
